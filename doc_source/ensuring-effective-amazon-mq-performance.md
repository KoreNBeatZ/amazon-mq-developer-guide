# Ensuring Effective Amazon MQ Performance<a name="ensuring-effective-amazon-mq-performance"></a>

The following design patterns can improve the effectiveness and performance of your Amazon MQ broker\.

## Disable Concurrent Store and Dispatch for Queues with Slow Consumers<a name="disable-concurrent-store-and-dispatch-queues-flag-slow-consumers"></a>

By default, Amazon MQ optimizes for queues with fast consumers:
+ Consumers are considered *fast* if they are able to keep up with the rate of messages generated by producers\.
+ Consumers are considered *slow* if a queue builds up a backlog of unacknowledged messages, potentially causing a decrease in producer throughput\.

To instruct Amazon MQ to optimize for queues with slow consumers, set the `concurrentStoreAndDispatchQueues` attribute to `false`\. For an example configuration, see [`concurrentStoreAndDispatchQueues`](child-element-details.md#concurrentStoreAndDispatchQueues)\.

## Choose the Correct Broker Instance Type for the Best Throughput<a name="broker-instance-types-choosing"></a>

The message throughput of a [broker instance type](broker.md#broker-instance-types) depends on your application's use case and the following factors:
+ Use of ActiveMQ in persistent mode
+ Message size
+ The number of producers and consumers
+ The number of destinations

### Understanding the Relationship Between Message Size, Latency, and Throughput<a name="broker-instance-types-message-size-latency-throughput"></a>

Depending on your use case, a larger broker instance type might not necessarily improve system throughput\. When ActiveMQ writes messages to durable storage, the size of your messages determines your system's limiting factor:
+ If your messages are smaller than 100 KB, persistent storage latency is the limiting factor\.
+ If your messages are larger than 100 KB, persistent storage throughput is the limiting factor\.

When you use ActiveMQ in persistent mode, writing to storage normally occurs when there are either few consumers or when the consumers are slow\. In non\-persistent mode, writing to storage also occurs with slow consumers if the heap memory of the broker instance is full\. Because Amazon MQ has highly\-durable storage \(all persistent messages are replicated across three Availability Zones\), the throughput to persistent storage is smaller than the throughput to local, single\-AZ storage\.

To determine the best broker instance type for your application, we recommend testing different broker instance types\. For more information, see [Instance Types](broker.md#broker-instance-types) and also [Measuring the Throughput for Amazon MQ using the JMS Benchmark](https://aws.amazon.com/blogs/compute/measuring-the-throughput-for-amazon-mq-using-the-jms-benchmark/)\.

**Note**  
You can't change an existing broker to a different broker instance type\. Using a different broker instance type requires [creating a new broker](amazon-mq-creating-configuring-broker.md), [modifying your application's configuration](amazon-mq-connecting-application.md) to use the new broker's wire\-level protocol endpoint, and deleting the old broker\. You must also drain all the messages from the old broker before using the new broker\.

### Use Cases for Larger Broker Instance Types<a name="broker-instance-types-larger-use-cases"></a>

There are three common use cases when larger broker instance types improve throughput:
+ **Non\-persistent mode** – When your application is less sensitive to losing messages during [broker instance failover](active-standby-broker-deployment.md) \(for example, when broadcasting sports scores\), you can often use ActiveMQ's non\-persistent mode\. In this mode, ActiveMQ writes messages to persistent storage only if the heap memory of the broker instance is full\. Systems that use non\-persistent mode can benefit from the higher amount of memory, faster CPU, and faster network available on larger broker instance types\.
+ **Fast consumers** – When active consumers are available and the [`concurrentStoreAndDispatchQueues`](child-element-details.md#concurrentStoreAndDispatchQueues) flag is enabled, ActiveMQ allows messages to flow directly from producer to consumer without sending messages to storage \(even in persistent mode\)\. If your application can consume messages quickly \(or if you can design your consumers to do this\), your application can benefit from a larger broker instance type\. To let your application consume messages more quickly, add consumer threads to your application instances or scale up your application instances vertically or horizontally\.
+ **Batched transactions** – When you use persistent mode and send multiple messages per transaction, you can achieve an overall higher message throughput by using larger broker instance types\. For more information, see [Should I Use Transactions?](http://activemq.apache.org/should-i-use-transactions.html) in the ActiveMQ documentation\.